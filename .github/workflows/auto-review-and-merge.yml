name: Auto Review & Merge

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review-and-merge:
    runs-on: ubuntu-latest

    # Only run on PRs created by the OpenAPI Dependabot workflow
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      contains(github.event.pull_request.labels.*.name, 'openapi-update')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          persist-credentials: true

      - name: Validate PR structure
        id: validate
        run: |
          echo "üîç Validating PR changes..."

          # Check if only expected files are changed
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path')

          echo "üìã Changed files:"
          echo "$CHANGED_FILES"

          VALID=true
          for file in $CHANGED_FILES; do
            # Allow changes to openapi/, repos.json, and UPDATE_SUMMARY.txt
            if [[ ! "$file" =~ ^openapi/ ]] && [[ "$file" != "repos.json" ]] && [[ "$file" != "UPDATE_SUMMARY.txt" ]]; then
              echo "‚ùå Unexpected file change: $file"
              VALID=false
            fi
          done

          if [ "$VALID" = true ]; then
            echo "‚úÖ All file changes are valid"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Invalid file changes detected"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.REVIEWER_BOT_TOKEN }}

      - name: Validate OpenAPI files
        if: steps.validate.outputs.valid == 'true'
        id: validate_openapi
        run: |
          echo "üîç Validating OpenAPI specification structure..."

          VALIDATION_PASSED=true

          # Find all openapi.yaml files in the changed files
          OPENAPI_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path' | grep 'openapi.yaml$' || true)

          if [ -z "$OPENAPI_FILES" ]; then
            echo "‚ö†Ô∏è No OpenAPI files found in this PR"
            echo "openapi_valid=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          for file in $OPENAPI_FILES; do
            echo "üìÑ Checking: $file"

            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "‚ùå File not found: $file"
              VALIDATION_PASSED=false
              continue
            fi

            # Check if corresponding .metadata.json exists
            DIR=$(dirname "$file")
            METADATA_FILE="$DIR/.metadata.json"

            if [ ! -f "$METADATA_FILE" ]; then
              echo "‚ùå Missing metadata file: $METADATA_FILE"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Metadata file exists: $METADATA_FILE"
            fi

            # Basic YAML syntax validation (check if file is readable)
            if ! grep -q "openapi:" "$file" 2>/dev/null; then
              echo "‚ùå Invalid OpenAPI file (missing 'openapi:' field): $file"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Valid OpenAPI format: $file"
            fi
          done

          if [ "$VALIDATION_PASSED" = true ]; then
            echo "‚úÖ All OpenAPI validations passed"
            echo "openapi_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå OpenAPI validation failed"
            echo "openapi_valid=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.REVIEWER_BOT_TOKEN }}

      - name: Approve PR
        if: steps.validate.outputs.valid == 'true' && steps.validate_openapi.outputs.openapi_valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: "APPROVE",
              body: "‚úÖ Auto-approved by Ballerina Bot\n\n**Validation Results:**\n- ‚úÖ File structure verified\n- ‚úÖ Only expected files modified\n- ‚úÖ OpenAPI specifications validated\n- ‚úÖ Ready to merge\n\n---\nü§ñ Automated approval by Ballerina Bot"
            });

            console.log("‚úÖ PR approved successfully by Ballerina Bot");

      - name: Enable auto-merge
        if: steps.validate.outputs.valid == 'true' && steps.validate_openapi.outputs.openapi_valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          script: |
            try {
              // Enable auto-merge with squash method
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                merge_method: "squash",
                commit_title: `${context.payload.pull_request.title} (#${context.payload.pull_request.number})`,
                commit_message: "Automated merge of OpenAPI specification updates"
              });

              console.log("‚úÖ PR merged successfully");

              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: "‚úÖ **Auto-merge completed successfully**\n\nThe OpenAPI specifications have been merged to main. Connector regeneration will be triggered automatically.\n\n---\nü§ñ Ballerina Bot"
              });

            } catch (error) {
              console.error("‚ùå Failed to merge PR:", error);

              // Comment on PR about merge failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: "‚ö†Ô∏è **Auto-merge failed**\n\nPlease review and merge manually.\n\n**Error:** " + error.message + "\n\n---\nü§ñ Ballerina Bot"
              });

              throw error;
            }

      - name: Comment on validation failure
        if: steps.validate.outputs.valid == 'false' || steps.validate_openapi.outputs.openapi_valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REVIEWER_BOT_TOKEN }}
          script: |
            const fileValidation = '${{ steps.validate.outputs.valid }}' === 'true' ? '‚úÖ' : '‚ùå';
            const openapiValidation = '${{ steps.validate_openapi.outputs.openapi_valid }}' === 'true' ? '‚úÖ' : '‚ùå';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `‚ö†Ô∏è **Auto-merge skipped: Validation failed**

              **Validation Results:**
              ${fileValidation} File structure validation
              ${openapiValidation} OpenAPI specification validation

              Please review the changes manually before merging.

              ---
              ü§ñ Ballerina Bot`
              });
